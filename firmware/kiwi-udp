#include <WiFi.h>
#include <WiFiUdp.h>

// ---------------- WIFI SETTINGS ----------------
const char* ssid = "OLIN-DEVICES";
const char* password = "BestOval4Engineers!";

// ---------------- UDP SETTINGS -----------------
WiFiUDP udp;
const unsigned int localUdpPort = 54321;

// ---------------- COUNTER ----------------------
unsigned long heartbeatCounter = 0;
unsigned long lastHeartbeat = 0;

void setup() {
  Serial.begin(9600);

  // Connect to Wi-Fi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("Connected! IP: ");
  Serial.println(WiFi.localIP());

  // Start UDP
  udp.begin(localUdpPort);
  Serial.print("UDP bound on port ");
  Serial.println(localUdpPort);
}

void loop() {
  unsigned long now = millis();

  // Send heartbeat every 100ms
  if (now - lastHeartbeat >= 100) {
    lastHeartbeat = now;
    heartbeatCounter++;

    // Broadcast heartbeat to local network
    udp.beginPacket(IPAddress(255, 255, 255, 255), localUdpPort);
    char buf[32];
    sprintf(buf, "HB %lu", heartbeatCounter);
    udp.write(buf);
    udp.endPacket();

    // Local print
    Serial.print("Heartbeat sent: ");
    Serial.println(heartbeatCounter);
  }

  delay(10);
}
